{% extends "wms/base_boot.html" %}
{% load staticfiles %}
{% block content %}
    <script src="{% static "wms/js/client_details.js" %}" type="text/javascript" ></script>
    <script src="{% static "wms/js/bootbox.js" %}" type="text/javascript" ></script>
    <script>
    var csrf = '{{ csrf_token }}';
    var ni = '{{client_details.ni_number}}';
    var symbol = 'GOOG'
    </script>
    <div id="stock_info" class="col-md-12">
    <div class="col-md-3" ></div>
        <div class="col-md-6 text-center" style="padding-top: 10">
            <div class="col-md-4" >
            </div>
            <div class="col-md-4">
                <span id="stock_name" class="text-uppercase" style="font-size: 150%">Goog</span>
            </div>
            <div class="col-md-4">
            </div>

        </div>
        <div class="col-md-3" style="padding-top: 5">
                <form id="buy_stock_index"class="form-inline "action="" method="post">
                    <div class="col-md-10">
                        <label class="sr-only">Stock Symbol</label>
                        <input id="symbol_input" class="form-control" type="text" name="symbol" placeholder="Stock Symbol"/>
                    </div>
                    <div class="col-md-2">
                        <button id="search_stock_submit" class="btn btn-default " type="submit" value="Submit" >Go</button>
                    </div>


                </form>
        </div>
        <div id="buy_stock_graph_container" class="col-md-11">
            <canvas id="buy_stock_graph" ></canvas>
        </div>
        <div class="col-md-1">
            <div id="lineLegend" ></div>
        </div>
        <div class="col-md-12 text-center">
            <form id="buy_graph_timescale_index" class="form-inline" method="post">
                <div class="btn-group btn-group-xs" role="group">
                    <input id="symbol_i" class="hidden" name="symbol" value="{{ symbol }}"/>
                    <span class="glyphicon glyphicon-time" aria-hidden="true"></span> Timescale
                    <br><button type="submit" class="btn btn-default" name="days" value="3">3 days</button>
                    <button type="submit" class="btn btn-default active" name="days" value="7">1 week</button>
                    <button type="submit" class="btn btn-default" name="days" value="30">1 month</button>
                    <button type="submit" class="btn btn-default" name="days" value="90">3 months</button>
                    <button type="submit" class="btn btn-default" name="days" value="180">6 months</button>
                    <button type="submit" class="btn btn-default" name="days" value="365">1 year</button>
                </div>
            </form>
            <hr>
        </div>

    <script>
    $(document).ready(function() {
        $('#buy_stock_index').submit( function(event){
            event.preventDefault();
            var symbol_input = $("#symbol_input").val();
            $("#buy_graph_timescale_index > div > button.active").removeClass("active");
            $("button[type=submit][value='7']").addClass("active");
            buy_lookup(7,symbol_input);
        });
        $("#buy_graph_timescale_index").submit(function(event){
            event.preventDefault();
            var symbol_input = $("#stock_name").html();

            $("#buy_graph_timescale_index > div > button.active").removeClass("active");
            $(this).find("button[type=submit]:focus").addClass("active");
            buy_lookup($(this).find("button[type=submit]:focus").attr("value"),symbol_input);

        })
    });
    function buy_lookup(num,sym){
            console.log("ping")
            $("#search_stock_submit").button('loading');
            num_days = parseInt(num);
            symbol = sym;
            $.ajax({
                url: "/query_api/",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    days: num_days,
                    ni: '{{client_details.ni_number}}',
                    symbol: sym
                },
                success: function (json){
                    result = json.result;
                    $("#search_stock_submit").button('reset');
                    if (json.result == "Stock not found"){
                        $("#stock_not_found").removeClass("hidden");
                        $("#stock_graph").addClass("hidden");
                        $("#lineLegend").addClass("hidden");
                        $("#modal_footer").addClass("hidden");
                        $("#stock_buy").addClass("hidden");
                        $("#symbol_title").addClass("hidden");
                        $("#buy_graph_timescale").addClass("hidden")
                    }else if (json.result == "success"){
                        recent_close = json["query"]["results"]["quote"][0]["Adj_Close"];
                        recent_date = json["query"]["results"]["quote"][0]["Date"];
                        shares_owned = json["shares_owned"];
                        $("#stock_name").html(symbol);
                        var result = json.query.results.quote.reverse();
                        make_graph(result,"buy_stock_graph","lineLegend");
                    }else{
                         bootbox.alert('Error, please seek the system administrator')
                    }
                },
                error: function (xhr, errmsg, err) {
                    $("#search_stock_submit").button('reset');
                    bootbox.alert('Failed.');
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
    }

    </script>

    </div>
    <div class="table-responsive col-md-12">
        <h1 class="text-center" style="color: #000000">Results</h1>
        <table class = "table table-hover table-condensed table-bordered" style="background-color: #ffffff">

        {% for key in stock_json.0 %}
            <th>{{ key }}</th>
        {% endfor %}
        <tbody >
            {% for result in stock_json %}
                <tr>
                    {% for key,data in result.items %}
                        <td>{{ data }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>


        </table>
    </div>


    <script>


    var dates = [];
    var open = [];
    var close = [];
	var high = [];
	var low = [];

    {% for result in stock_json reversed%}
        dates[dates.length] = "{{result.Date}}";
        open[open.length] = "{{ result.Open }}";
        close[close.length] = "{{ result.Close }}";
		high[high.length] = "{{ result.High }}";
		low[low.length] = "{{ result.Low }}";
    {% endfor %}

    var stock_graph = document.getElementById('buy_stock_graph').getContext('2d');
    var stockData = {
	labels : dates,
	datasets : [
		{
            label : "Open",
			fillColor : "rgba(223,181,17,0)",
			strokeColor : "#DFB511",
			pointColor : "#DFB511",
			pointStrokeColor : "#34495e",
			data : open
		},
         {
            label : "Close",
			fillColor : "rgba(0,107,195,0)",
			strokeColor : "#006BC3",
			pointColor : "#006BC3",
			pointStrokeColor : "#34495e",
			data : close
		},
		{
            label : "High",
			fillColor : "rgba(9,192,9,0)",
			strokeColor : "#09C009",
			pointColor : "#09C009",
			pointStrokeColor : "#34495e",
			data : high
		},
		{
            label : "Low",
			fillColor : "rgba(218,7,7,0)",
			strokeColor : "#DA0707",
			pointColor : "#DA0707",
			pointStrokeColor : "#34495e",
			data : low
		}

	]
    };
    var opts = {scaleFontColor: "#000000",
            scaleLineColor: "#000000",
            scaleGridLineColor: "#000000",
            scaleShowLabels: true,
            bezierCurve: false,
            scaleShowVerticalLines: true,
            responsive: true,
            animation: false,
            pointDot : false
        };

    new Chart(stock_graph).Line(stockData, opts);
    legend(document.getElementById("lineLegend"),stockData);
</script>

{%  endblock %}
