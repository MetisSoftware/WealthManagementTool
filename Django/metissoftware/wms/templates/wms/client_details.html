{% extends "wms/base_boot.html" %}
{% load staticfiles %}

{% block content %}
<script src="{% static "wms/js/fullcalendar/moment.min.js" %}" type="text/javascript" ></script>
{% if client_details %}
    <div class="table-responsive col-md-3 well">
        <img class="img-responsive img-thumbnail" src="{% static 'wms/images/person-placeholder.png'  %}" alt="Person Placeholder">
        <p class="lead">{{client_details.first_name}} {{client_details.middle_name}} {{client_details.surname}}</p>
        <ul class="list-unstyled">
            <li>
                <span class="glyphicon glyphicon-envelope"> </span> <strong>Email:</strong> {{ client_details.email}}
            </li>
            <li>
                <span class="glyphicon glyphicon-earphone"></span> <strong>Phone:</strong>
                <ul class="">
                    <li>
                        <span class="glyphicon glyphicon-phone"></span> <strong>Mobile:</strong> {{ client_details.mob_phone}}
                    </li>
                    <li>
                        <span class="glyphicon glyphicon-phone-alt"></span> <strong>Home:</strong> {{ client_details.home_phone}}
                    </li>
                </ul>
            </li>
            <li>
                <span class="glyphicon glyphicon-user"></span> <strong>NI:</strong> {{client_details.ni_number}}
            </li>
            <li>
                <span class="glyphicon glyphicon-gift"></span> <strong>Dob:</strong> {{client_details.dob}}
            </li>
            <li>
                <span class="glyphicon glyphicon-flag"></span> <strong>Financial Advisor:</strong> {{client_details.fa}}
            </li>
        </ul>
    </div>
    <div class = "col-md-9">
    <div class="col-md-12 well container-fluid" id="users" >
        <div class="row">
            <div class="col-md-3">Cash available: $<span class="client_cash_available">{{ client_details.cash }}</span></div>
            <div class="btn-group col-md-6" style="margin-bottom:1%;">
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#StockModal">Buy Stock</button>
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#DepositModal">Deposit Cash</button>
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#WithdrawModal">Withdraw Cash</button>
             </div>
            <div class="col-md-3">Portfolio worth: $<span class="portfolio_worth"></span> </div>
        </div>
        <div class="row">
            <div>
                <label class="sr-only">Stock Symbol</label>
                <input id="symbol_input" class="form-control search" type="text" name="symbol" placeholder="Stock Symbol"style="margin-bottom:1%;"/>
            </div>
        </div>
    <script>
        var portfolio_worth =0;
    </script>
        <div class="row table-responsive" style="height: 70%">
            <table class="table table-hover table-bordered table-condensed col-md-12" style="background-color: #ffffff; ">
                <thead>
                    <th class="sort" data-sort="stock" id="stock_th">Stock <span class="glyphicon glyphicon-triangle-top"></span></th>
                    <th class="sort" data-sort="buy_date">Date bought <span></span></th>
                    <th class="sort" data-sort="amount">Amount <span></span></th>
                    <th class="sort" data-sort="price">Price($) <span></span></th>
                    <th class="sort" data-sort="total">Total($) <span></span></th>
                    <th>Sell</th>
                </thead>
                <tbody id="clients_stock_tbody" class="list" style="overflow-y: scroll;height: 50%">
                    {% for share in shares %}
                    <tr>
                        <td class="stock"><a href="/?symbol={{share.stock}}">{{ share.stock}}</a></td>
                        <td class="buy_date">{{ share.buy_date}}</td>
                        <td class="amount">{{ share.amount}}</td>
                        <td class="price">{{ share.price}}</td>
                        <script>
                            var t = ({{share.price}} * {{share.amount}});
                            portfolio_worth = (portfolio_worth + parseFloat(t));

                        </script>
                        <td class="total"><script>document.write(({{share.price}}*{{share.amount}}).toFixed(2));</script></td>
                        <td class="sell"><button class="btn btn-default btn-xs">Sell</button> </td>
                    </tr>
                    {% endfor %}
                    <script>
                        $(".portfolio_worth").html(portfolio_worth.toFixed(2));
                    </script>
                </tbody>

            </table>
        </div>
        <script type="text/javascript">
            var options ={
                valueNames: ['stock', 'buy_date', 'amount', 'price', 'total']
            };
            var userList = new List('users',options);
            userList.sort("stock", { order: "asc"});
            $("th.sort").click(function(event){
                $("th.sort").children("span").removeClass("glyphicon glyphicon-triangle-top glyphicon-triangle-bottom");
                $("th.sort.asc").children("span").addClass("glyphicon glyphicon-triangle-top");
                $("th.sort.desc").children("span").addClass("glyphicon glyphicon-triangle-bottom");
            });
        </script>
    </div>
    </div>

    <!--Buy stock modal-->
    <div class=" modal fade" tabindex="-1" id="StockModal" role="dialog" >
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                     <h4 class="modal-title" id="exampleModalLabel">Buy Shares</h4>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <form id="buySharesForm" class="form-inline" action="/query_api/" method="get">
                            <div class="form-group">
                                <label class="sr-only">Stock Symbol</label>
                                <input id="stock_symbol" class="form-control" type="text" name="symbol" placeholder="Stock Symbol" />
                                <button id="search_stock_submit" class="btn btn-primary form-control glyphicon glyphicon-search" type="submit" value="Submit" data-loading-text=" Searching..." > Search</button>
                            </div>

                            <div class="form-group">

                            </div>

                        </form>


                        <h3 id="symbol_title" class="text-center"></h3>
                        <div id="stock_not_found" class="alert alert-danger hidden">Unable to find stock! Please check you have entered a valid stock symbol.</div>
                        <div class="row">
                            <div class="col-md-11">
                                   <canvas id="stock_graph" class="hidden"></canvas>
                            </div>
                            <div class="col-md-1">
                                <div id="lineLegend" class="hidden"></div>
                            </div>


                        </div>

                    </div>
                </div>
                <div id="modal_footer" class="modal-footer">
                    <div id="stock_buy" class="hidden">
                        <form class="form-inline" id="buy_buttonForm">
                            <div class="form-group">
                                <p id="buy_text"></p>
                                <label for="buy_quantity">Quantity: </label>
                                <input id="buy_quantity" class="form-control" placeholder="1" style="width: 100px">
                                <button id="buy_button" class="btn btn-default form-control" type="submit" value="Buy">Buy</button>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Deposit Cash-->
    <div class=" modal fade" tabindex="-1" id="DepositModal" role="dialog" >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                     <h4 class="modal-title" id="exampleModalLabel">Deposit Cash</h4>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <form id="depositForm" class="form-inline" action="/deposit/" method="get">
                            <div class="form-group">
                                <div >Cash available: $<span class="client_cash_available">{{ client_details.cash }}</span></div>
                                <div class="input-group">

                                    <div class="input-group-addon">$</div>
                                    <input id="deposit_amount" class="form-control" type="text" placeholder="Amount"/>
                                </div>
                                <button class="btn btn-default form-control" type="submit" value="Submit" >Deposit</button>
                            </div>

                            <div class="form-group">

                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
     $(document).ready(function() {
                $('#depositForm').submit( function(event){
                    event.preventDefault();
                    var amount = $("#deposit_amount").val();
                        $.ajax({
                            url: "/deposit_cash/",
                            type: "POST",
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                amount: amount,
                                ni: '{{ client_details.ni_number }}'
                            },
                            success: function (json){
                                if(json["result"] == "success"){
                                    alert("Cash deposited");
                                    $(".client_cash_available").html(json["new_amount"]);
                                    $("#DepositModal").modal("toggle");
                                }else if(json["result"] == "Insufficient funds"){
                                    alert('Insufficient funds');

                                }else if(json["result"] == "Client not found"){
                                    alert("client not found")
                                }else if(json["result"]=="amount_error"){
                                    alert("Please enter an amount")
                                }else{
                                    alert('Error, please seek the system administrator')
                                }
                            },
                            error: function (xhr, errmsg, err) {
                                alert('Failed.');
                                console.log(xhr.status + ": " + xhr.responseText);
                            }
                        });
                })
            });
    </script>

    <!-- Withdraw Cash moadl-->
    <div class=" modal fade" tabindex="-1" id="WithdrawModal" role="dialog" >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                     <h4 class="modal-title" id="exampleModalLabel">Withdraw Cash</h4>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <form id="withdrawForm" class="form-inline" action="/withdraw_cash/" method="get">
                            <div class="form-group">
                                <!--TODO update available cash filed-->
                                <div >Cash available: $<span class="client_cash_available">{{ client_details.cash }}</span></div>
                                <label class="sr-only">Stock Symbol</label>
                                <div class="input-group">
                                    <div class="input-group-addon">$</div>
                                    <input id="withdraw_amount" class="form-control" type="text" placeholder="Amount"/>
                                </div>
                                <button class="btn btn-primary form-control" type="submit" value="Submit" >Submit</button>
                            </div>

                            <div class="form-group">

                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
     <script>
     $(document).ready(function() {
                $('#withdrawForm').submit( function(event){
                    event.preventDefault();
                    var amount = $("#withdraw_amount").val();
                        $.ajax({
                            url: "/withdraw_cash/",
                            type: "POST",
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                amount: amount,
                                ni: '{{ client_details.ni_number }}'
                            },
                            success: function (json){
                                if(json["result"] == "success"){
                                    alert("Cash withdrawn");
                                    $(".client_cash_available").html(json["new_amount"]);
                                    $("#WithdrawModal").modal("toggle");
                                }else if(json["result"] == "Insufficient funds"){
                                    alert('Insufficient funds');

                                }else if(json["result"] == "Client not found") {
                                    alert("client not found")

                                }else if(json["result"]=="amount_error"){
                                    alert("Please enter an amount")
                                }else{
                                    alert('Error, please seek the system administrator')
                                }
                            },
                            error: function (xhr, errmsg, err) {
                                alert('Failed.');
                                console.log(xhr.status + ": " + xhr.responseText);
                            }
                        });
                })
            });
    </script>



        <script type="text/javascript">
        var symbol;
        var recent_close;
        var recent_date;
        var quantity;

        function print_results(json) {
            var result = json.query.results.quote;
            symbol = result[0]["Symbol"].toUpperCase();
            recent_close = result[0]["Adj_Close"];
            recent_date = result[0]["Date"];
            $("#symbol_title").html(symbol);

            $("#stock_not_found").addClass("hidden");

             $("#symbol_title").removeClass("hidden");
            $("#table_div").removeClass("hidden");
            $("#stock_graph").removeClass("hidden");
            $("#lineLegend").removeClass("hidden");
            $("#modal_footer").removeClass("hidden");
            $("#stock_buy").removeClass("hidden");


            $("#thead_result").html("");
            for (key in result[0]){
                $("#thead_result").append("<th>" + key + "</th>");
            }
            for (var quote in result) {
                $("#tbody_results").append("<tr>");
                for (var key in result[quote]) {
                    $("#tbody_results").append("<td>" + result[quote][key] + "</td>");
                }
                $("#tbody_results").append("</tr>");
            }

            make_graph(result);
            setup_buy()
        }
        function setup_buy(){
            $("#buy_text").html(" "+symbol+" at $"+ recent_close);
        }

            $(document).ready(function() {
                $('#buySharesForm').submit( function(event){
                    event.preventDefault();
                    $("#search_stock_submit").button('loading');
                    var symbol = $("#stock_symbol").val();
                        $.ajax({
                            url: "/query_api/",
                            type: "POST",
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                symbol: symbol,
                                days: 5
                            },
                            success: function (json){
                                $("#search_stock_submit").button('reset');
                                console.log("Success");
                                console.log(json.query.count);
                                if(json.query.count== 0){
                                    $("#stock_not_found").removeClass("hidden");
                                    $("#table_div").removeClass("hidden");
                                    $("#stock_graph").addClass("hidden");
                                    $("#lineLegend").addClass("hidden");
                                    $("#modal_footer").addClass("hidden");
                                    $("#stock_buy").addClass("hidden");
                                    $("#symbol_title").addClass("hidden");
                                }else {

                                    print_results(json);
                                }
                            },
                            error: function (xhr, errmsg, err) {
                                $("#search_stock_submit").button('reset');
                                alert('Failed.');
                                console.log(xhr.status + ": " + xhr.responseText);
                            }
                        });
                })
            });

            $(document).ready(function(){
                $("#buy_buttonForm").submit(function (event){
                    event.preventDefault();
                    quantity = $("#buy_quantity").val();
                    if (quantity == ""){
                        quantity = 1;
                    }
                    var data = {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                symbol: symbol,
                                ni: '{{client_details.ni_number}}',
                                price: recent_close,
                                amount: quantity,
                                date: recent_date
                            }
                    $.ajax({
                            url: "/buy_stock/",
                            type: "POST",
                            data: data,
                            success: function (json){
                                if(json["result"] == "success"){
                                    alert("Stocks bought")

                                    update_stock_table(data);
                                    portfolio_worth += (recent_close * quantity);
                                    $(".portfolio_worth").html(portfolio_worth.toFixed(2));
                                    $("#StockModal").modal("toggle");
                                }else if(json["result"] == "Insufficient funds"){
                                    alert('Insufficient funds');
                                }else{
                                    alert('Error, please seek the system administrator')
                                }
                            },
                            error: function (xhr, errmsg, err) {
                                alert('Failed.');
                                console.log(xhr.status + ": " + xhr.responseText);
                            }
                        });
                })
            })
        </script>

    <script>

    function update_stock_table(data){
        var d = moment(data['date']);

        $("#clients_stock_tbody").append("<tr>"+
                    "<td class='stock'><a href='/wmt/?symbol=data['symbol']'>"+data['symbol']+"</a></td>"+
                    "<td class='buy_date'>"+ d.format("LL")+"</td>"+
                    "<td class='amount'>"+data['amount']+"</td>"+
                    "<td class='price'>"+data['price']+"</td>"+
                    "<td class='total'>"+(data['price'] * data['amount']).toFixed(2)+"</td>"+
                "</tr>")
    }

    function make_graph(result) {
        var dates = [];
        var open = [];
        var close = [];
        var high = [];
        var low = [];

        for (var key in result){
            console.log(key);
            dates[dates.length] = result[key]["Date"];
            open[open.length] = result[key]["Open"] ;
            close[close.length] = result[key]["Close"] ;
            high[high.length] = result[key]["High"] ;
            low[low.length] = result[key]["Low"] ;
        }

        var stock_graph = document.getElementById('stock_graph').getContext('2d');
        var stockData = {
            labels: dates,
            datasets: [
                {
                    label: "Open",
                    fillColor: "rgba(223,181,17,0)",
                    strokeColor: "#DFB511",
                    pointColor: "#DFB511",
                    pointStrokeColor: "#34495e",
                    data: open
                },
                {
                    label: "Close",
                    fillColor: "rgba(0,107,195,0)",
                    strokeColor: "#006BC3",
                    pointColor: "#006BC3",
                    pointStrokeColor: "#34495e",
                    data: close
                },
                {
                    label: "High",
                    fillColor: "rgba(9,192,9,0)",
                    strokeColor: "#09C009",
                    pointColor: "#09C009",
                    pointStrokeColor: "#34495e",
                    data: high
                },
                {
                    label: "Low",
                    fillColor: "rgba(218,7,7,0)",
                    strokeColor: "#DA0707",
                    pointColor: "#DA0707",
                    pointStrokeColor: "#34495e",
                    data: low
                }

            ]
        };
        var opts = {scaleFontColor: "#000000",
            scaleLineColor: "#000000",
            scaleGridLineColor: "#000000",
            scaleShowLabels: true,
            bezierCurve: false,
            scaleShowVerticalLines: true,
            responsive: true
        };

        new Chart(stock_graph).Line(stockData, opts);
        legend(document.getElementById("lineLegend"), stockData);
    }
    </script>
    {% if twitter == True %}
        <a class="twitter-timeline" href="https://twitter.com/{{client_details.twitter_username}}" data-widget-id="{{client_details.twitter_widget_id}}">Tweets</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    {% endif %}
    {% else %}
        <p>No client data</p>
    {% endif %}
{%  endblock %}
